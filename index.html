<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Exploratory Data Assignment</title>

    <meta charset="UTF-8">

    <script src="js/jquery-1.9.1.min.js"></script>
    <script src="js/d3.v3.min.js"></script>
    <script src="js/crossfilter.min.js"></script>
    <script src="js/dc.min.js"></script>

    <link rel="stylesheet" href="css/dc.css"/>
</head>
<body>
<div id="map" class="dc-chart">
    <span>Number of People Per Age Group</span>
    <a class="reset" href="javascript:usChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
    <span class="reset" style="display: none;"> | Current filter: <span class="filter"></span></span>
    <div class="clearfix"></div>
</div>
<div id="industry" class="dc-chart">
    <span>Average Ratings Per State - Look here cause this is incredible</span>
    <a class="reset" href="javascript:roundChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
    <div class="bubble"></div>
</div>
<div id="bar" class="dc-chart">
    <span>Age Distribution</span>
    <a class="reset" href="javascript:roundChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
    <div class="clearfix"></div>
</div>
<div id="bar2" class="dc-chart">
    <span>Publish Year Distribution</span>
    <a class="reset" href="javascript:roundChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
    <div class="clearfix"></div>
</div>
<div id="data-count">
    <span class="filter-count"></span> selected out of <span class="total-count"></span> records
</div>

<script type="text/javascript">

    var map = dc.geoChoroplethChart("#map")
                .projection(d3.geo.albersUsa());
    var barchart = dc.barChart("#bar");
    var barchart2 = dc.barChart("#bar2");
    var industryChart = dc.bubbleChart("#industry");

    d3.csv("data/FinalData.csv", function (csv) {
        var data = crossfilter(csv);

        var user = data.dimension(function(d){return d.user_id;});//fix
        var usercount = user.groupAll();

        var pubyear = data.dimension(function(d){return d.year_publication;});
        var pubyearGroup = pubyear.group();

        var age = data.dimension(function(d){return d.age;});//fix
        var ageGroup = age.group();//fix

        var r2 = data.dimension(function(d){return d.book_rating;});//fix
        var ratingGroup = r2.group();
        console.log(ratingGroup.key);

        var states = data.dimension(function (d) {
            return d.state;
        });
        var avgStateRating = states.group().reduce(
                    //add
                    function (p, v) {
                        ++p.count;
                        p.total += +v.book_rating;
                        p.totalpub += +v.year_publication;
                        p.avg = p.total / p.count;
                        return p;
                    },
                    //remove
                    function (p, v) {
                        --p.count;
                        p.total -= +v.book_rating;
                        p.totalpub -= +v.year_publication;
                        p.avg = p.count == 0 ? 0 : p.total / p.count;
                        return p;
                    },
                    //init
                    function () {
                        return {count: 0,total: 0, totalpub: 0,avg: 0};
                    }
            );
        var groupByState = states.group();
        console.log(groupByState);


    
    d3.json('data/us-states.json',function(statesJson){
                map.width(920)
                    .height(500)
                    .dimension(states)
                    .group(groupByState)
                    .colors(["#ccc", "#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"])
                    .colorDomain([0,1000])
                    .overlayGeoJson(statesJson.features, "state", function (d) {
                        return d.properties.name;
                    });


                barchart.width(920) // (optional) define chart width, :default = 200
                    .height(300) // (optional) define chart height, :default = 200
                    .transitionDuration(500) // (optional) define chart transition duration, 
                    .margins({top: 10, right: 50, bottom: 30, left: 60})
                    .dimension(age)
                    .group(ageGroup)
                    .elasticY(true)
                    .x(d3.scale.linear()
                        .domain([10,90])
                        .range([1,10]))
                    .y(d3.scale.linear()
                        .domain([10,8000])
                        .range([1,10]))
                    .xUnits(function(){return 90-10;})
                    .brushOn(true)
                    .renderTitle(true);

                barchart2.width(920) // (optional) define chart width, :default = 200
                    .height(300) // (optional) define chart height, :default = 200
                    .transitionDuration(500) // (optional) define chart transition duration, 
                    .margins({top: 10, right: 50, bottom: 30, left: 60})
                    .dimension(pubyear)
                    .group(pubyearGroup)
                    .elasticY(true)
                    .x(d3.scale.linear()
                        .domain([1950,2005])
                        .range([1,10]))
                    .y(d3.scale.linear()
                        .domain([10,8000])
                        .range([1,10]))
                    .xUnits(function(){return 2005-1950;})
                    .brushOn(true)
                    .renderTitle(true);

                industryChart.width(400)
                    .height(800)
                    .margins({top: 30, right: 90, bottom: 50, left: 90})
                    .dimension(states)
                    .group(avgStateRating)
                    .colors(["transparent"])
                    .colorDomain([0,10])
                    .keyAccessor(function (p) {
                        return 1;
                    })
                    .valueAccessor(function (p) {
                        return p.value.avg*10;
                    })
                    .radiusValueAccessor(function (p) {
                        return p.value.count;
                    })
                    .colorAccessor(function (p) {
                        return p.value.totalpub;
                    })
                    .x(d3.scale.linear().domain([-10, 10]))
                    .y(d3.scale.linear().domain([-10, 100]))
                    .r(d3.scale.linear().domain([0, 100]))
                    .minRadiusWithLabel(0)
                    .yAxisPadding(100)
                    .maxBubbleRelativeSize(0.07)
                    .renderLabel(true);

                dc.dataCount("#data-count")
                    .dimension(data) // set dimension to all data
                    .group(usercount); // set group to ndx.groupAll()

                dc.renderAll();
        });
    });

</script>

    <div class="clear"></div>

    <div>
        <a href="javascript:dc.renderAll();">Render All</a>
        <a href="javascript:dc.filterAll(); dc.renderAll();">Filter All</a>
    </div>
</body>
</html>
